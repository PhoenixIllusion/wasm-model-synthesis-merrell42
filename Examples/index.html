<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Merrel42 Model Synth demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" type="text/css" href="style.css">
	</head>
	<body>
		<div id="container">Loading...</div>
		<script src="js/example.js"></script>

		<script type="module">
			// In case you haven't built the library yourself, replace URL with: https://www.unpkg.com/jolt-physics/dist/jolt-physics.wasm-compat.js
			import initWASM from './js/Merrel42ModelSynth.wasm.js';

      await readXML('data/samples.xml');
      await readXML('data/Summer/data.xml');

			initWASM({ XMLReader, IFStream, lodepng: LodePNG} ).then(async function (module) {
        window.module = module;

        const xml = module.Parser.prototype.readXML('sample.xml', 'samples');

        //const xml = await module.ccall('emscripten_bind_Parser_readXML_2', 'number', ['string','string'], ['sample.xml', 'samples'], {async: true});

        const timer = new module.Microseconds();

        const settings = module.Parser.prototype.parse(xml, timer);

        /*
        const settings = new module.InputSettings();
        setU32(settings.size, [32, 32, 1]);
        setU32(settings.blockSize, [16, 16, 1]);
        settings.periodic = false;
        settings.numDims = 2;
        settings.initialLabels = createU32(1, [0]);

        const transition = new module.Transition(4);
        settings.name = new module.CString('test', 4); 
        settings.transition = transition;
        */
        module.Parser.prototype.setRandomSeed(3);
        const synth = new module.Synthesizer(settings, timer);

        synth.synthesize(timer);

        const model = new module.Model(synth.getModel());
        const [ width, height, depth ] = getU32(settings.size, 3);

        const renderGrid = document.getElementById('container');
        renderGrid.innerHTML = '';
        renderGrid.style.gridTemplateColumns = `repeat(${width},1fr)`;
        for(let z = 0; z < depth; z++)
        for(let y = 0; y < height; y++) {
          let line = [];
          for(let x = 0; x < width; x++) {
            const label = model.get(x,y,z);
            const img = new Image();
            const url = LoadPngLookupR[label].replace('samples', 'data');
            if(/\d\./.test(url)) {
              img.src = url
            } else {
              img.src = url.replace('.',' 0.');
            }
            renderGrid.appendChild(img);
          }
        }
			});

		</script>
	</body>
</html>
